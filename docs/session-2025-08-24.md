# Session Summary — Data Registry, Importer, OCR (2025-08-24)

## What We Added/Changed

### Testdata Indexing + Tests
- Added registry generator to index real files under `testdata/`:
  - Parser: `packages/utils/src/testdata.ts` (classifies by year/quarter/kind, extracts `model`, `invoiceNo`).
  - Script: `scripts/build-testdata-registry.ts` → writes `testdata/registry.json`.
  - Root scripts: `pnpm testdata:registry`, tests in `packages/utils/test/testdata.test.ts`.

### Libro (Excel) Parsing + Import
- Excel parser: `packages/utils/src/libro.ts` using `xlsx` (with local type shim) → returns `emitidas/recibidas` rows.
- API import module: `apps/api/src/modules/imports/*`:
  - `POST /imports/libro` — import quarter from Libro (`dryRun` supported).
  - `POST /imports/attach` — attach PDFs by matching (emitidas exact number; recibidas heuristic by vendor/date).
  - `POST /imports/validate` — compare Libro vs DB totals; list missing attachments.
- Prisma: added `Attachment` model (links to `InvoiceIn`/`InvoiceOut`).

### OCR Service + OCR Import
- OCR service (`@services/ocr`):
  - Switched to `pdf-parse` text extraction; avoided upstream debug harness by importing `pdf-parse/lib/pdf-parse.js`.
  - Refactored parsing into `services/ocr/src/parser.ts` with vendor-specific + generic parsers.
  - Vendor aliases config: `services/ocr/src/config/vendors.json` (OpenAI, Anthropic, TaxScouts, OpenRouter, etc.).
  - Tests: `services/ocr/test/parser.test.ts` (OpenAI/Anthropic/TaxScouts/generic + alias detection). All pass.
- API OCR-backed import:
  - `POST /imports/ocr-file` — import single PDF from `testdata` via OCR (`relPath`, `direction: in|out`, `dryRun`).

### Reverse Charge Handling (Key for OpenAI invoices)
- OCR parser now detects:
  - `sellerNIF` including EU OSS-like IDs (e.g., `EU372041333`).
  - `reverseCharge` flag from text (e.g., “reverse charge”).
  - `euOss` (EU OSS ID detected) and `country` (basic heuristic from address).
- Import classification for `invoiceIn` (OCR path):
  - Reverse charge + EU supplier (country VAT like `PL...`): `category: reverse-charge-eu`, `euOperation: true`, supplier VAT 0.
  - Reverse charge + non‑EU supplier (OSS/US): `category: reverse-charge-non-eu`, `euOperation: false`, supplier VAT 0.
  - This aligns with 303 self-assessment and avoids misclassifying OSS as intra‑EU.

### Infra/CI Quality
- Fixed typecheck/lint across workspaces; added local shims for `xlsx` and `pdf-parse` subpath.
- Committed updated `pnpm-lock.yaml` to stabilize CI installs.

## How To Run
- Start everything: `pnpm dev` (web 3000, api 3000, ocr 4100).
- Generate registry: `pnpm testdata:registry`.
- Import Libro (dry-run):
  ```sh
  curl -X POST http://localhost:3000/imports/libro \
    -H 'Content-Type: application/json' \
    -d '{"year":2025,"quarter":1,"createdById":"<user-id>","dryRun":true}'
  ```
- Attach PDFs: `POST /imports/attach` with `{ "year": 2025, "quarter": 1 }`.
- Validate quarter: `POST /imports/validate` with `{ "year": 2025, "quarter": 1 }`.
- OCR import single file (dry-run example):
  ```sh
  curl -X POST http://localhost:3000/imports/ocr-file \
    -H 'Content-Type: application/json' \
    -d '{"relPath":"2025/trimestre-2/gastos/soft/OpenAI Invoice-728FD5FD-0024.pdf","direction":"in","createdById":"<user-id>","dryRun":true}'
  ```

## Notes On Tax Treatment (reverse charge)
- OpenAI invoices marked “Tax to be paid on reverse charge basis” and `EU OSS VAT EU372041333` are non‑EU OSS; not valid for VIES nor 349.
- We classify these as `reverse-charge-non-eu` (no `euOperation`). VAT is self-assessed in 303 (devengado y soportado) on the base in EUR.

## Proposed Next Steps

### 1) Model 303 Computation (Reverse Charge + General)
- Implement quarter aggregation service that:
  - Computes ISP devengado (casillas 12–13) for `reverse-charge-*` purchases at default 21% (configurable).
  - Computes soportado/deducible (casillas 28+) accordingly.
  - Handles regular sales, domestic purchases, EU customer sales rules (already in `InvoicesService` for `euOperation`).
- Output a JSON report and optionally a CSV for cross-checking with declarations.

### 2) VIES + Vendor Metadata
- Add VIES check utility and store validation snapshots (date + result) when a supplier/client provides a country VAT (`PL..., DE..., ...`).
- Extend vendor metadata (country, default rate, known reverse-charge behavior) to improve parser classification.

### 3) Batch OCR Import
- Endpoint/CLI to OCR-import all `gastos` in a quarter using `testdata/registry.json`:
  - Dry-run to estimate matches; report successes/failures with vendor/reason.
  - Option to attach PDFs and run validation automatically post-import.

### 4) UI Enhancements
- Add a “Registry Overview” page (apps/web) to display completeness per quarter: Libro present, declarations present, #invoices, missing attachments.
- Add a “Review OCR” page: drag-and-drop, preview parsed fields with confidence/snippets, approve → import.

### 5) Libro Normalization + AEAT Exports
- Normalize TaxScouts Libro XLSX to internal schema (already reading) and provide AEAT CSV export adapters (Libros formato AEAT) for future filing.

### 6) Hardening
- OCR `/health` and API graceful 503 when OCR is down; retries/backoff.
- Config-driven vendor alias overrides; add EU country list and rate mapping centrally.
- More precise country detection (ISO/NER) and per-vendor parsers (OpenRouter, JetBrains, Microsoft, Amazon).

## Open Questions / Inputs Needed
- Confirm desired default VAT rate for reverse-charge computation (21% unless specific reduced rates apply).
- Provide preferred UI flow for batch OCR review (approve/reject per item?).
- Confirm whether to prioritize 2025 T1/T2 for full import + 303 reconciliation first.

